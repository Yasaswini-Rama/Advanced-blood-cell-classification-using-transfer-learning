from keras.callbacks import EarlyStopping,ReduceLROnPlateau,ModelCheckpoint,TensorBoard,LambdaCallback
from keras.layers import Input,Dropout, Dense,GlobalAveragePooling2D
from keras.models import Sequential,Model
from keras.applications.inception_v3 import InceptionV3
from keras.preprocessing.image import ImageDataGenerator
from tensorflow.keras.preprocessing import image_dataset_from_directory
from sklearn.model_selection import train_test_split
from sklearn.metrics import confusion_matrix,classification_report
from sklearn.utils import shuffle
import matplotlib.pyplot as plt
from tensorflow import keras
import tensorflow as tf
from tqdm import tqdm
import seaborn as sns
import numpy as np
import itertools 
import datetime
import cv2
import os
import io
Data Preperation
Load all training and testing data

Initialize the training data augmentation object

Split 20 percents of Training dataset into Validation sets

Data Augmentation
In order to make the most of our few training examples, we will augment them via a number of random transformations, so that our model would never see twice the exact same picture. This helps prevent overfitting and helps the model generalize better.

labels = ['Basophil', 'Eosinophil', 'Lymphocyte', 'Monocyte','Neutrophil']


IMAGE_SIZE = 256
BATCH_SIZE = 20


TRAIN_PATH = 'drive/MyDrive/keras/wbc/Train'
TEST_PATH = 'drive/MyDrive/keras/wbc/Test'

# ImageDataGenerator transforms each image in the batch by a series of random translations, rotations, etc.
data_gen = ImageDataGenerator(rescale=1./255,
    width_shift_range=0.05,
    height_shift_range=0.05,
    horizontal_flip=True,vertical_flip=True,validation_split=0.2)


train_gen = data_gen.flow_from_directory(directory = TRAIN_PATH,subset='training',batch_size = BATCH_SIZE,color_mode = 'rgb',shuffle = True,class_mode = 'categorical',target_size = (IMAGE_SIZE, IMAGE_SIZE))

valid_gen = ImageDataGenerator(rescale=1./255,validation_split=0.2).flow_from_directory(directory = TRAIN_PATH,subset='validation',batch_size = BATCH_SIZE,color_mode = 'rgb',shuffle = False,class_mode = 'categorical',target_size = (IMAGE_SIZE, IMAGE_SIZE))

test_gen = ImageDataGenerator(rescale=1./255).flow_from_directory(directory = TEST_PATH,batch_size = BATCH_SIZE,color_mode = 'rgb',shuffle = False,class_mode = 'categorical',target_size = (IMAGE_SIZE, IMAGE_SIZE))
Found 8142 images belonging to 5 classes.
Found 2033 images belonging to 5 classes.
Found 4339 images belonging to 5 classes.
Visualize Data
# plot some image of our dataset
import matplotlib.pyplot as plt
import numpy as np

info = {0 : 'Basophil', 1 : 'Eosinophil', 2 : 'Lymphocyte', 3 : 'Monocyte',4:'Neutrophil'}
image,label = train_gen.next()

plt.figure(figsize = (12,12))
for i in range(6) :
    plt.subplot(4, 4, i+1)
    plt.imshow(image[i])
    plt.title(info[np.argmax(label[i])])
    plt.axis('off')
plt.show()

Fine Tuning
Fine tuning consists of unfreezing the entire model you obtained above (or part of it), and re-training it on the new data with a very low learning rate. This can potentially achieve meaningful improvements, by incrementally adapting the pretrained features to the new data.

In this project, I'll be using the InceptionV3 model which will use the weights from the ImageNet dataset.

Note

Setting include_top to False moves all the layer's weights from trainable to non-trainable. This is called "freezing" the layer: the state of a frozen layer won't be updated during training

net = InceptionV3(
    weights='imagenet', # Load weights pre-trained on ImageNet.
     include_top=False, # Do not include the ImageNet classifier at the top.
     input_shape=(IMAGE_SIZE,IMAGE_SIZE,3))

for layers in net.layers:
        layers.trainable=False
GlobalAveragePooling2D -> This layer acts similar to the Max Pooling layer in CNNs, the only difference being is that it uses the Average values instead of the Max value while pooling. This really helps in decreasing the computational load on the machine while training.

Dropout -> This layer omits some of the neurons at each step from the layer making the neurons more independent from the neibouring neurons. It helps in avoiding overfitting. Neurons to be ommitted are selected at random. The rate parameter is the liklihood of a neuron activation being set to 0, thus dropping out the neuron.

Dense -> This is the output layer which classifies the image into one of the 5 possible classes. It uses the softmax function which is a generalization of the sigmoid function.

model = net.output
model = GlobalAveragePooling2D()(model)
model = Dense(128, activation="relu")(model)
model = Dropout(0.15)(model)
model = Dense(5, activation="softmax")(model)
model = Model(inputs= net.input, outputs= model)

#compile our model.
adam = keras.optimizers.Adam(learning_rate=0.0001)
model.compile(optimizer=adam, loss = 'categorical_crossentropy', metrics=['accuracy'])
model.summary()
Model: "model_2"
__________________________________________________________________________________________________
 Layer (type)                   Output Shape         Param #     Connected to                     
==================================================================================================
 input_3 (InputLayer)           [(None, 256, 256, 3  0           []                               
                                )]                                                                
                                                                                                  
 conv2d_188 (Conv2D)            (None, 127, 127, 32  864         ['input_3[0][0]']                
                                )                                                                 
                                                                                                  
 batch_normalization_188 (Batch  (None, 127, 127, 32  96         ['conv2d_188[0][0]']             
 Normalization)                 )                                                                 
                                                                                                  
 activation_188 (Activation)    (None, 127, 127, 32  0           ['batch_normalization_188[0][0]']
                                )                                                                 
                                                                                                  
 conv2d_189 (Conv2D)            (None, 125, 125, 32  9216        ['activation_188[0][0]']         
                                )                                                                 
                                                                                                  
 batch_normalization_189 (Batch  (None, 125, 125, 32  96         ['conv2d_189[0][0]']             
 Normalization)                 )                                                                 
                                                                                                  
 activation_189 (Activation)    (None, 125, 125, 32  0           ['batch_normalization_189[0][0]']
                                )                                                                 
                                                                                                  
 conv2d_190 (Conv2D)            (None, 125, 125, 64  18432       ['activation_189[0][0]']         
                                )                                                                 
                                                                                                  
 batch_normalization_190 (Batch  (None, 125, 125, 64  192        ['conv2d_190[0][0]']             
 Normalization)                 )                                                                 
                                                                                                  
 activation_190 (Activation)    (None, 125, 125, 64  0           ['batch_normalization_190[0][0]']
                                )                                                                 
                                                                                                  
 max_pooling2d_8 (MaxPooling2D)  (None, 62, 62, 64)  0           ['activation_190[0][0]']         
                                                                                                  
 conv2d_191 (Conv2D)            (None, 62, 62, 80)   5120        ['max_pooling2d_8[0][0]']        
                                                                                                  
 batch_normalization_191 (Batch  (None, 62, 62, 80)  240         ['conv2d_191[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_191 (Activation)    (None, 62, 62, 80)   0           ['batch_normalization_191[0][0]']
                                                                                                  
 conv2d_192 (Conv2D)            (None, 60, 60, 192)  138240      ['activation_191[0][0]']         
                                                                                                  
 batch_normalization_192 (Batch  (None, 60, 60, 192)  576        ['conv2d_192[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_192 (Activation)    (None, 60, 60, 192)  0           ['batch_normalization_192[0][0]']
                                                                                                  
 max_pooling2d_9 (MaxPooling2D)  (None, 29, 29, 192)  0          ['activation_192[0][0]']         
                                                                                                  
 conv2d_196 (Conv2D)            (None, 29, 29, 64)   12288       ['max_pooling2d_9[0][0]']        
                                                                                                  
 batch_normalization_196 (Batch  (None, 29, 29, 64)  192         ['conv2d_196[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_196 (Activation)    (None, 29, 29, 64)   0           ['batch_normalization_196[0][0]']
                                                                                                  
 conv2d_194 (Conv2D)            (None, 29, 29, 48)   9216        ['max_pooling2d_9[0][0]']        
                                                                                                  
 conv2d_197 (Conv2D)            (None, 29, 29, 96)   55296       ['activation_196[0][0]']         
                                                                                                  
 batch_normalization_194 (Batch  (None, 29, 29, 48)  144         ['conv2d_194[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_197 (Batch  (None, 29, 29, 96)  288         ['conv2d_197[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_194 (Activation)    (None, 29, 29, 48)   0           ['batch_normalization_194[0][0]']
                                                                                                  
 activation_197 (Activation)    (None, 29, 29, 96)   0           ['batch_normalization_197[0][0]']
                                                                                                  
 average_pooling2d_18 (AverageP  (None, 29, 29, 192)  0          ['max_pooling2d_9[0][0]']        
 ooling2D)                                                                                        
                                                                                                  
 conv2d_193 (Conv2D)            (None, 29, 29, 64)   12288       ['max_pooling2d_9[0][0]']        
                                                                                                  
 conv2d_195 (Conv2D)            (None, 29, 29, 64)   76800       ['activation_194[0][0]']         
                                                                                                  
 conv2d_198 (Conv2D)            (None, 29, 29, 96)   82944       ['activation_197[0][0]']         
                                                                                                  
 conv2d_199 (Conv2D)            (None, 29, 29, 32)   6144        ['average_pooling2d_18[0][0]']   
                                                                                                  
 batch_normalization_193 (Batch  (None, 29, 29, 64)  192         ['conv2d_193[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_195 (Batch  (None, 29, 29, 64)  192         ['conv2d_195[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_198 (Batch  (None, 29, 29, 96)  288         ['conv2d_198[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_199 (Batch  (None, 29, 29, 32)  96          ['conv2d_199[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_193 (Activation)    (None, 29, 29, 64)   0           ['batch_normalization_193[0][0]']
                                                                                                  
 activation_195 (Activation)    (None, 29, 29, 64)   0           ['batch_normalization_195[0][0]']
                                                                                                  
 activation_198 (Activation)    (None, 29, 29, 96)   0           ['batch_normalization_198[0][0]']
                                                                                                  
 activation_199 (Activation)    (None, 29, 29, 32)   0           ['batch_normalization_199[0][0]']
                                                                                                  
 mixed0 (Concatenate)           (None, 29, 29, 256)  0           ['activation_193[0][0]',         
                                                                  'activation_195[0][0]',         
                                                                  'activation_198[0][0]',         
                                                                  'activation_199[0][0]']         
                                                                                                  
 conv2d_203 (Conv2D)            (None, 29, 29, 64)   16384       ['mixed0[0][0]']                 
                                                                                                  
 batch_normalization_203 (Batch  (None, 29, 29, 64)  192         ['conv2d_203[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_203 (Activation)    (None, 29, 29, 64)   0           ['batch_normalization_203[0][0]']
                                                                                                  
 conv2d_201 (Conv2D)            (None, 29, 29, 48)   12288       ['mixed0[0][0]']                 
                                                                                                  
 conv2d_204 (Conv2D)            (None, 29, 29, 96)   55296       ['activation_203[0][0]']         
                                                                                                  
 batch_normalization_201 (Batch  (None, 29, 29, 48)  144         ['conv2d_201[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_204 (Batch  (None, 29, 29, 96)  288         ['conv2d_204[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_201 (Activation)    (None, 29, 29, 48)   0           ['batch_normalization_201[0][0]']
                                                                                                  
 activation_204 (Activation)    (None, 29, 29, 96)   0           ['batch_normalization_204[0][0]']
                                                                                                  
 average_pooling2d_19 (AverageP  (None, 29, 29, 256)  0          ['mixed0[0][0]']                 
 ooling2D)                                                                                        
                                                                                                  
 conv2d_200 (Conv2D)            (None, 29, 29, 64)   16384       ['mixed0[0][0]']                 
                                                                                                  
 conv2d_202 (Conv2D)            (None, 29, 29, 64)   76800       ['activation_201[0][0]']         
                                                                                                  
 conv2d_205 (Conv2D)            (None, 29, 29, 96)   82944       ['activation_204[0][0]']         
                                                                                                  
 conv2d_206 (Conv2D)            (None, 29, 29, 64)   16384       ['average_pooling2d_19[0][0]']   
                                                                                                  
 batch_normalization_200 (Batch  (None, 29, 29, 64)  192         ['conv2d_200[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_202 (Batch  (None, 29, 29, 64)  192         ['conv2d_202[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_205 (Batch  (None, 29, 29, 96)  288         ['conv2d_205[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_206 (Batch  (None, 29, 29, 64)  192         ['conv2d_206[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_200 (Activation)    (None, 29, 29, 64)   0           ['batch_normalization_200[0][0]']
                                                                                                  
 activation_202 (Activation)    (None, 29, 29, 64)   0           ['batch_normalization_202[0][0]']
                                                                                                  
 activation_205 (Activation)    (None, 29, 29, 96)   0           ['batch_normalization_205[0][0]']
                                                                                                  
 activation_206 (Activation)    (None, 29, 29, 64)   0           ['batch_normalization_206[0][0]']
                                                                                                  
 mixed1 (Concatenate)           (None, 29, 29, 288)  0           ['activation_200[0][0]',         
                                                                  'activation_202[0][0]',         
                                                                  'activation_205[0][0]',         
                                                                  'activation_206[0][0]']         
                                                                                                  
 conv2d_210 (Conv2D)            (None, 29, 29, 64)   18432       ['mixed1[0][0]']                 
                                                                                                  
 batch_normalization_210 (Batch  (None, 29, 29, 64)  192         ['conv2d_210[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_210 (Activation)    (None, 29, 29, 64)   0           ['batch_normalization_210[0][0]']
                                                                                                  
 conv2d_208 (Conv2D)            (None, 29, 29, 48)   13824       ['mixed1[0][0]']                 
                                                                                                  
 conv2d_211 (Conv2D)            (None, 29, 29, 96)   55296       ['activation_210[0][0]']         
                                                                                                  
 batch_normalization_208 (Batch  (None, 29, 29, 48)  144         ['conv2d_208[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_211 (Batch  (None, 29, 29, 96)  288         ['conv2d_211[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_208 (Activation)    (None, 29, 29, 48)   0           ['batch_normalization_208[0][0]']
                                                                                                  
 activation_211 (Activation)    (None, 29, 29, 96)   0           ['batch_normalization_211[0][0]']
                                                                                                  
 average_pooling2d_20 (AverageP  (None, 29, 29, 288)  0          ['mixed1[0][0]']                 
 ooling2D)                                                                                        
                                                                                                  
 conv2d_207 (Conv2D)            (None, 29, 29, 64)   18432       ['mixed1[0][0]']                 
                                                                                                  
 conv2d_209 (Conv2D)            (None, 29, 29, 64)   76800       ['activation_208[0][0]']         
                                                                                                  
 conv2d_212 (Conv2D)            (None, 29, 29, 96)   82944       ['activation_211[0][0]']         
                                                                                                  
 conv2d_213 (Conv2D)            (None, 29, 29, 64)   18432       ['average_pooling2d_20[0][0]']   
                                                                                                  
 batch_normalization_207 (Batch  (None, 29, 29, 64)  192         ['conv2d_207[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_209 (Batch  (None, 29, 29, 64)  192         ['conv2d_209[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_212 (Batch  (None, 29, 29, 96)  288         ['conv2d_212[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_213 (Batch  (None, 29, 29, 64)  192         ['conv2d_213[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_207 (Activation)    (None, 29, 29, 64)   0           ['batch_normalization_207[0][0]']
                                                                                                  
 activation_209 (Activation)    (None, 29, 29, 64)   0           ['batch_normalization_209[0][0]']
                                                                                                  
 activation_212 (Activation)    (None, 29, 29, 96)   0           ['batch_normalization_212[0][0]']
                                                                                                  
 activation_213 (Activation)    (None, 29, 29, 64)   0           ['batch_normalization_213[0][0]']
                                                                                                  
 mixed2 (Concatenate)           (None, 29, 29, 288)  0           ['activation_207[0][0]',         
                                                                  'activation_209[0][0]',         
                                                                  'activation_212[0][0]',         
                                                                  'activation_213[0][0]']         
                                                                                                  
 conv2d_215 (Conv2D)            (None, 29, 29, 64)   18432       ['mixed2[0][0]']                 
                                                                                                  
 batch_normalization_215 (Batch  (None, 29, 29, 64)  192         ['conv2d_215[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_215 (Activation)    (None, 29, 29, 64)   0           ['batch_normalization_215[0][0]']
                                                                                                  
 conv2d_216 (Conv2D)            (None, 29, 29, 96)   55296       ['activation_215[0][0]']         
                                                                                                  
 batch_normalization_216 (Batch  (None, 29, 29, 96)  288         ['conv2d_216[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_216 (Activation)    (None, 29, 29, 96)   0           ['batch_normalization_216[0][0]']
                                                                                                  
 conv2d_214 (Conv2D)            (None, 14, 14, 384)  995328      ['mixed2[0][0]']                 
                                                                                                  
 conv2d_217 (Conv2D)            (None, 14, 14, 96)   82944       ['activation_216[0][0]']         
                                                                                                  
 batch_normalization_214 (Batch  (None, 14, 14, 384)  1152       ['conv2d_214[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_217 (Batch  (None, 14, 14, 96)  288         ['conv2d_217[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_214 (Activation)    (None, 14, 14, 384)  0           ['batch_normalization_214[0][0]']
                                                                                                  
 activation_217 (Activation)    (None, 14, 14, 96)   0           ['batch_normalization_217[0][0]']
                                                                                                  
 max_pooling2d_10 (MaxPooling2D  (None, 14, 14, 288)  0          ['mixed2[0][0]']                 
 )                                                                                                
                                                                                                  
 mixed3 (Concatenate)           (None, 14, 14, 768)  0           ['activation_214[0][0]',         
                                                                  'activation_217[0][0]',         
                                                                  'max_pooling2d_10[0][0]']       
                                                                                                  
 conv2d_222 (Conv2D)            (None, 14, 14, 128)  98304       ['mixed3[0][0]']                 
                                                                                                  
 batch_normalization_222 (Batch  (None, 14, 14, 128)  384        ['conv2d_222[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_222 (Activation)    (None, 14, 14, 128)  0           ['batch_normalization_222[0][0]']
                                                                                                  
 conv2d_223 (Conv2D)            (None, 14, 14, 128)  114688      ['activation_222[0][0]']         
                                                                                                  
 batch_normalization_223 (Batch  (None, 14, 14, 128)  384        ['conv2d_223[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_223 (Activation)    (None, 14, 14, 128)  0           ['batch_normalization_223[0][0]']
                                                                                                  
 conv2d_219 (Conv2D)            (None, 14, 14, 128)  98304       ['mixed3[0][0]']                 
                                                                                                  
 conv2d_224 (Conv2D)            (None, 14, 14, 128)  114688      ['activation_223[0][0]']         
                                                                                                  
 batch_normalization_219 (Batch  (None, 14, 14, 128)  384        ['conv2d_219[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_224 (Batch  (None, 14, 14, 128)  384        ['conv2d_224[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_219 (Activation)    (None, 14, 14, 128)  0           ['batch_normalization_219[0][0]']
                                                                                                  
 activation_224 (Activation)    (None, 14, 14, 128)  0           ['batch_normalization_224[0][0]']
                                                                                                  
 conv2d_220 (Conv2D)            (None, 14, 14, 128)  114688      ['activation_219[0][0]']         
                                                                                                  
 conv2d_225 (Conv2D)            (None, 14, 14, 128)  114688      ['activation_224[0][0]']         
                                                                                                  
 batch_normalization_220 (Batch  (None, 14, 14, 128)  384        ['conv2d_220[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_225 (Batch  (None, 14, 14, 128)  384        ['conv2d_225[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_220 (Activation)    (None, 14, 14, 128)  0           ['batch_normalization_220[0][0]']
                                                                                                  
 activation_225 (Activation)    (None, 14, 14, 128)  0           ['batch_normalization_225[0][0]']
                                                                                                  
 average_pooling2d_21 (AverageP  (None, 14, 14, 768)  0          ['mixed3[0][0]']                 
 ooling2D)                                                                                        
                                                                                                  
 conv2d_218 (Conv2D)            (None, 14, 14, 192)  147456      ['mixed3[0][0]']                 
                                                                                                  
 conv2d_221 (Conv2D)            (None, 14, 14, 192)  172032      ['activation_220[0][0]']         
                                                                                                  
 conv2d_226 (Conv2D)            (None, 14, 14, 192)  172032      ['activation_225[0][0]']         
                                                                                                  
 conv2d_227 (Conv2D)            (None, 14, 14, 192)  147456      ['average_pooling2d_21[0][0]']   
                                                                                                  
 batch_normalization_218 (Batch  (None, 14, 14, 192)  576        ['conv2d_218[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_221 (Batch  (None, 14, 14, 192)  576        ['conv2d_221[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_226 (Batch  (None, 14, 14, 192)  576        ['conv2d_226[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_227 (Batch  (None, 14, 14, 192)  576        ['conv2d_227[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_218 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_218[0][0]']
                                                                                                  
 activation_221 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_221[0][0]']
                                                                                                  
 activation_226 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_226[0][0]']
                                                                                                  
 activation_227 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_227[0][0]']
                                                                                                  
 mixed4 (Concatenate)           (None, 14, 14, 768)  0           ['activation_218[0][0]',         
                                                                  'activation_221[0][0]',         
                                                                  'activation_226[0][0]',         
                                                                  'activation_227[0][0]']         
                                                                                                  
 conv2d_232 (Conv2D)            (None, 14, 14, 160)  122880      ['mixed4[0][0]']                 
                                                                                                  
 batch_normalization_232 (Batch  (None, 14, 14, 160)  480        ['conv2d_232[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_232 (Activation)    (None, 14, 14, 160)  0           ['batch_normalization_232[0][0]']
                                                                                                  
 conv2d_233 (Conv2D)            (None, 14, 14, 160)  179200      ['activation_232[0][0]']         
                                                                                                  
 batch_normalization_233 (Batch  (None, 14, 14, 160)  480        ['conv2d_233[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_233 (Activation)    (None, 14, 14, 160)  0           ['batch_normalization_233[0][0]']
                                                                                                  
 conv2d_229 (Conv2D)            (None, 14, 14, 160)  122880      ['mixed4[0][0]']                 
                                                                                                  
 conv2d_234 (Conv2D)            (None, 14, 14, 160)  179200      ['activation_233[0][0]']         
                                                                                                  
 batch_normalization_229 (Batch  (None, 14, 14, 160)  480        ['conv2d_229[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_234 (Batch  (None, 14, 14, 160)  480        ['conv2d_234[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_229 (Activation)    (None, 14, 14, 160)  0           ['batch_normalization_229[0][0]']
                                                                                                  
 activation_234 (Activation)    (None, 14, 14, 160)  0           ['batch_normalization_234[0][0]']
                                                                                                  
 conv2d_230 (Conv2D)            (None, 14, 14, 160)  179200      ['activation_229[0][0]']         
                                                                                                  
 conv2d_235 (Conv2D)            (None, 14, 14, 160)  179200      ['activation_234[0][0]']         
                                                                                                  
 batch_normalization_230 (Batch  (None, 14, 14, 160)  480        ['conv2d_230[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_235 (Batch  (None, 14, 14, 160)  480        ['conv2d_235[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_230 (Activation)    (None, 14, 14, 160)  0           ['batch_normalization_230[0][0]']
                                                                                                  
 activation_235 (Activation)    (None, 14, 14, 160)  0           ['batch_normalization_235[0][0]']
                                                                                                  
 average_pooling2d_22 (AverageP  (None, 14, 14, 768)  0          ['mixed4[0][0]']                 
 ooling2D)                                                                                        
                                                                                                  
 conv2d_228 (Conv2D)            (None, 14, 14, 192)  147456      ['mixed4[0][0]']                 
                                                                                                  
 conv2d_231 (Conv2D)            (None, 14, 14, 192)  215040      ['activation_230[0][0]']         
                                                                                                  
 conv2d_236 (Conv2D)            (None, 14, 14, 192)  215040      ['activation_235[0][0]']         
                                                                                                  
 conv2d_237 (Conv2D)            (None, 14, 14, 192)  147456      ['average_pooling2d_22[0][0]']   
                                                                                                  
 batch_normalization_228 (Batch  (None, 14, 14, 192)  576        ['conv2d_228[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_231 (Batch  (None, 14, 14, 192)  576        ['conv2d_231[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_236 (Batch  (None, 14, 14, 192)  576        ['conv2d_236[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_237 (Batch  (None, 14, 14, 192)  576        ['conv2d_237[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_228 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_228[0][0]']
                                                                                                  
 activation_231 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_231[0][0]']
                                                                                                  
 activation_236 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_236[0][0]']
                                                                                                  
 activation_237 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_237[0][0]']
                                                                                                  
 mixed5 (Concatenate)           (None, 14, 14, 768)  0           ['activation_228[0][0]',         
                                                                  'activation_231[0][0]',         
                                                                  'activation_236[0][0]',         
                                                                  'activation_237[0][0]']         
                                                                                                  
 conv2d_242 (Conv2D)            (None, 14, 14, 160)  122880      ['mixed5[0][0]']                 
                                                                                                  
 batch_normalization_242 (Batch  (None, 14, 14, 160)  480        ['conv2d_242[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_242 (Activation)    (None, 14, 14, 160)  0           ['batch_normalization_242[0][0]']
                                                                                                  
 conv2d_243 (Conv2D)            (None, 14, 14, 160)  179200      ['activation_242[0][0]']         
                                                                                                  
 batch_normalization_243 (Batch  (None, 14, 14, 160)  480        ['conv2d_243[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_243 (Activation)    (None, 14, 14, 160)  0           ['batch_normalization_243[0][0]']
                                                                                                  
 conv2d_239 (Conv2D)            (None, 14, 14, 160)  122880      ['mixed5[0][0]']                 
                                                                                                  
 conv2d_244 (Conv2D)            (None, 14, 14, 160)  179200      ['activation_243[0][0]']         
                                                                                                  
 batch_normalization_239 (Batch  (None, 14, 14, 160)  480        ['conv2d_239[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_244 (Batch  (None, 14, 14, 160)  480        ['conv2d_244[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_239 (Activation)    (None, 14, 14, 160)  0           ['batch_normalization_239[0][0]']
                                                                                                  
 activation_244 (Activation)    (None, 14, 14, 160)  0           ['batch_normalization_244[0][0]']
                                                                                                  
 conv2d_240 (Conv2D)            (None, 14, 14, 160)  179200      ['activation_239[0][0]']         
                                                                                                  
 conv2d_245 (Conv2D)            (None, 14, 14, 160)  179200      ['activation_244[0][0]']         
                                                                                                  
 batch_normalization_240 (Batch  (None, 14, 14, 160)  480        ['conv2d_240[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_245 (Batch  (None, 14, 14, 160)  480        ['conv2d_245[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_240 (Activation)    (None, 14, 14, 160)  0           ['batch_normalization_240[0][0]']
                                                                                                  
 activation_245 (Activation)    (None, 14, 14, 160)  0           ['batch_normalization_245[0][0]']
                                                                                                  
 average_pooling2d_23 (AverageP  (None, 14, 14, 768)  0          ['mixed5[0][0]']                 
 ooling2D)                                                                                        
                                                                                                  
 conv2d_238 (Conv2D)            (None, 14, 14, 192)  147456      ['mixed5[0][0]']                 
                                                                                                  
 conv2d_241 (Conv2D)            (None, 14, 14, 192)  215040      ['activation_240[0][0]']         
                                                                                                  
 conv2d_246 (Conv2D)            (None, 14, 14, 192)  215040      ['activation_245[0][0]']         
                                                                                                  
 conv2d_247 (Conv2D)            (None, 14, 14, 192)  147456      ['average_pooling2d_23[0][0]']   
                                                                                                  
 batch_normalization_238 (Batch  (None, 14, 14, 192)  576        ['conv2d_238[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_241 (Batch  (None, 14, 14, 192)  576        ['conv2d_241[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_246 (Batch  (None, 14, 14, 192)  576        ['conv2d_246[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_247 (Batch  (None, 14, 14, 192)  576        ['conv2d_247[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_238 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_238[0][0]']
                                                                                                  
 activation_241 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_241[0][0]']
                                                                                                  
 activation_246 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_246[0][0]']
                                                                                                  
 activation_247 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_247[0][0]']
                                                                                                  
 mixed6 (Concatenate)           (None, 14, 14, 768)  0           ['activation_238[0][0]',         
                                                                  'activation_241[0][0]',         
                                                                  'activation_246[0][0]',         
                                                                  'activation_247[0][0]']         
                                                                                                  
 conv2d_252 (Conv2D)            (None, 14, 14, 192)  147456      ['mixed6[0][0]']                 
                                                                                                  
 batch_normalization_252 (Batch  (None, 14, 14, 192)  576        ['conv2d_252[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_252 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_252[0][0]']
                                                                                                  
 conv2d_253 (Conv2D)            (None, 14, 14, 192)  258048      ['activation_252[0][0]']         
                                                                                                  
 batch_normalization_253 (Batch  (None, 14, 14, 192)  576        ['conv2d_253[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_253 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_253[0][0]']
                                                                                                  
 conv2d_249 (Conv2D)            (None, 14, 14, 192)  147456      ['mixed6[0][0]']                 
                                                                                                  
 conv2d_254 (Conv2D)            (None, 14, 14, 192)  258048      ['activation_253[0][0]']         
                                                                                                  
 batch_normalization_249 (Batch  (None, 14, 14, 192)  576        ['conv2d_249[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_254 (Batch  (None, 14, 14, 192)  576        ['conv2d_254[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_249 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_249[0][0]']
                                                                                                  
 activation_254 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_254[0][0]']
                                                                                                  
 conv2d_250 (Conv2D)            (None, 14, 14, 192)  258048      ['activation_249[0][0]']         
                                                                                                  
 conv2d_255 (Conv2D)            (None, 14, 14, 192)  258048      ['activation_254[0][0]']         
                                                                                                  
 batch_normalization_250 (Batch  (None, 14, 14, 192)  576        ['conv2d_250[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_255 (Batch  (None, 14, 14, 192)  576        ['conv2d_255[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_250 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_250[0][0]']
                                                                                                  
 activation_255 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_255[0][0]']
                                                                                                  
 average_pooling2d_24 (AverageP  (None, 14, 14, 768)  0          ['mixed6[0][0]']                 
 ooling2D)                                                                                        
                                                                                                  
 conv2d_248 (Conv2D)            (None, 14, 14, 192)  147456      ['mixed6[0][0]']                 
                                                                                                  
 conv2d_251 (Conv2D)            (None, 14, 14, 192)  258048      ['activation_250[0][0]']         
                                                                                                  
 conv2d_256 (Conv2D)            (None, 14, 14, 192)  258048      ['activation_255[0][0]']         
                                                                                                  
 conv2d_257 (Conv2D)            (None, 14, 14, 192)  147456      ['average_pooling2d_24[0][0]']   
                                                                                                  
 batch_normalization_248 (Batch  (None, 14, 14, 192)  576        ['conv2d_248[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_251 (Batch  (None, 14, 14, 192)  576        ['conv2d_251[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_256 (Batch  (None, 14, 14, 192)  576        ['conv2d_256[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_257 (Batch  (None, 14, 14, 192)  576        ['conv2d_257[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_248 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_248[0][0]']
                                                                                                  
 activation_251 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_251[0][0]']
                                                                                                  
 activation_256 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_256[0][0]']
                                                                                                  
 activation_257 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_257[0][0]']
                                                                                                  
 mixed7 (Concatenate)           (None, 14, 14, 768)  0           ['activation_248[0][0]',         
                                                                  'activation_251[0][0]',         
                                                                  'activation_256[0][0]',         
                                                                  'activation_257[0][0]']         
                                                                                                  
 conv2d_260 (Conv2D)            (None, 14, 14, 192)  147456      ['mixed7[0][0]']                 
                                                                                                  
 batch_normalization_260 (Batch  (None, 14, 14, 192)  576        ['conv2d_260[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_260 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_260[0][0]']
                                                                                                  
 conv2d_261 (Conv2D)            (None, 14, 14, 192)  258048      ['activation_260[0][0]']         
                                                                                                  
 batch_normalization_261 (Batch  (None, 14, 14, 192)  576        ['conv2d_261[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_261 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_261[0][0]']
                                                                                                  
 conv2d_258 (Conv2D)            (None, 14, 14, 192)  147456      ['mixed7[0][0]']                 
                                                                                                  
 conv2d_262 (Conv2D)            (None, 14, 14, 192)  258048      ['activation_261[0][0]']         
                                                                                                  
 batch_normalization_258 (Batch  (None, 14, 14, 192)  576        ['conv2d_258[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_262 (Batch  (None, 14, 14, 192)  576        ['conv2d_262[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_258 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_258[0][0]']
                                                                                                  
 activation_262 (Activation)    (None, 14, 14, 192)  0           ['batch_normalization_262[0][0]']
                                                                                                  
 conv2d_259 (Conv2D)            (None, 6, 6, 320)    552960      ['activation_258[0][0]']         
                                                                                                  
 conv2d_263 (Conv2D)            (None, 6, 6, 192)    331776      ['activation_262[0][0]']         
                                                                                                  
 batch_normalization_259 (Batch  (None, 6, 6, 320)   960         ['conv2d_259[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_263 (Batch  (None, 6, 6, 192)   576         ['conv2d_263[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_259 (Activation)    (None, 6, 6, 320)    0           ['batch_normalization_259[0][0]']
                                                                                                  
 activation_263 (Activation)    (None, 6, 6, 192)    0           ['batch_normalization_263[0][0]']
                                                                                                  
 max_pooling2d_11 (MaxPooling2D  (None, 6, 6, 768)   0           ['mixed7[0][0]']                 
 )                                                                                                
                                                                                                  
 mixed8 (Concatenate)           (None, 6, 6, 1280)   0           ['activation_259[0][0]',         
                                                                  'activation_263[0][0]',         
                                                                  'max_pooling2d_11[0][0]']       
                                                                                                  
 conv2d_268 (Conv2D)            (None, 6, 6, 448)    573440      ['mixed8[0][0]']                 
                                                                                                  
 batch_normalization_268 (Batch  (None, 6, 6, 448)   1344        ['conv2d_268[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_268 (Activation)    (None, 6, 6, 448)    0           ['batch_normalization_268[0][0]']
                                                                                                  
 conv2d_265 (Conv2D)            (None, 6, 6, 384)    491520      ['mixed8[0][0]']                 
                                                                                                  
 conv2d_269 (Conv2D)            (None, 6, 6, 384)    1548288     ['activation_268[0][0]']         
                                                                                                  
 batch_normalization_265 (Batch  (None, 6, 6, 384)   1152        ['conv2d_265[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_269 (Batch  (None, 6, 6, 384)   1152        ['conv2d_269[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_265 (Activation)    (None, 6, 6, 384)    0           ['batch_normalization_265[0][0]']
                                                                                                  
 activation_269 (Activation)    (None, 6, 6, 384)    0           ['batch_normalization_269[0][0]']
                                                                                                  
 conv2d_266 (Conv2D)            (None, 6, 6, 384)    442368      ['activation_265[0][0]']         
                                                                                                  
 conv2d_267 (Conv2D)            (None, 6, 6, 384)    442368      ['activation_265[0][0]']         
                                                                                                  
 conv2d_270 (Conv2D)            (None, 6, 6, 384)    442368      ['activation_269[0][0]']         
                                                                                                  
 conv2d_271 (Conv2D)            (None, 6, 6, 384)    442368      ['activation_269[0][0]']         
                                                                                                  
 average_pooling2d_25 (AverageP  (None, 6, 6, 1280)  0           ['mixed8[0][0]']                 
 ooling2D)                                                                                        
                                                                                                  
 conv2d_264 (Conv2D)            (None, 6, 6, 320)    409600      ['mixed8[0][0]']                 
                                                                                                  
 batch_normalization_266 (Batch  (None, 6, 6, 384)   1152        ['conv2d_266[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_267 (Batch  (None, 6, 6, 384)   1152        ['conv2d_267[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_270 (Batch  (None, 6, 6, 384)   1152        ['conv2d_270[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_271 (Batch  (None, 6, 6, 384)   1152        ['conv2d_271[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 conv2d_272 (Conv2D)            (None, 6, 6, 192)    245760      ['average_pooling2d_25[0][0]']   
                                                                                                  
 batch_normalization_264 (Batch  (None, 6, 6, 320)   960         ['conv2d_264[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_266 (Activation)    (None, 6, 6, 384)    0           ['batch_normalization_266[0][0]']
                                                                                                  
 activation_267 (Activation)    (None, 6, 6, 384)    0           ['batch_normalization_267[0][0]']
                                                                                                  
 activation_270 (Activation)    (None, 6, 6, 384)    0           ['batch_normalization_270[0][0]']
                                                                                                  
 activation_271 (Activation)    (None, 6, 6, 384)    0           ['batch_normalization_271[0][0]']
                                                                                                  
 batch_normalization_272 (Batch  (None, 6, 6, 192)   576         ['conv2d_272[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_264 (Activation)    (None, 6, 6, 320)    0           ['batch_normalization_264[0][0]']
                                                                                                  
 mixed9_0 (Concatenate)         (None, 6, 6, 768)    0           ['activation_266[0][0]',         
                                                                  'activation_267[0][0]']         
                                                                                                  
 concatenate_4 (Concatenate)    (None, 6, 6, 768)    0           ['activation_270[0][0]',         
                                                                  'activation_271[0][0]']         
                                                                                                  
 activation_272 (Activation)    (None, 6, 6, 192)    0           ['batch_normalization_272[0][0]']
                                                                                                  
 mixed9 (Concatenate)           (None, 6, 6, 2048)   0           ['activation_264[0][0]',         
                                                                  'mixed9_0[0][0]',               
                                                                  'concatenate_4[0][0]',          
                                                                  'activation_272[0][0]']         
                                                                                                  
 conv2d_277 (Conv2D)            (None, 6, 6, 448)    917504      ['mixed9[0][0]']                 
                                                                                                  
 batch_normalization_277 (Batch  (None, 6, 6, 448)   1344        ['conv2d_277[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_277 (Activation)    (None, 6, 6, 448)    0           ['batch_normalization_277[0][0]']
                                                                                                  
 conv2d_274 (Conv2D)            (None, 6, 6, 384)    786432      ['mixed9[0][0]']                 
                                                                                                  
 conv2d_278 (Conv2D)            (None, 6, 6, 384)    1548288     ['activation_277[0][0]']         
                                                                                                  
 batch_normalization_274 (Batch  (None, 6, 6, 384)   1152        ['conv2d_274[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_278 (Batch  (None, 6, 6, 384)   1152        ['conv2d_278[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_274 (Activation)    (None, 6, 6, 384)    0           ['batch_normalization_274[0][0]']
                                                                                                  
 activation_278 (Activation)    (None, 6, 6, 384)    0           ['batch_normalization_278[0][0]']
                                                                                                  
 conv2d_275 (Conv2D)            (None, 6, 6, 384)    442368      ['activation_274[0][0]']         
                                                                                                  
 conv2d_276 (Conv2D)            (None, 6, 6, 384)    442368      ['activation_274[0][0]']         
                                                                                                  
 conv2d_279 (Conv2D)            (None, 6, 6, 384)    442368      ['activation_278[0][0]']         
                                                                                                  
 conv2d_280 (Conv2D)            (None, 6, 6, 384)    442368      ['activation_278[0][0]']         
                                                                                                  
 average_pooling2d_26 (AverageP  (None, 6, 6, 2048)  0           ['mixed9[0][0]']                 
 ooling2D)                                                                                        
                                                                                                  
 conv2d_273 (Conv2D)            (None, 6, 6, 320)    655360      ['mixed9[0][0]']                 
                                                                                                  
 batch_normalization_275 (Batch  (None, 6, 6, 384)   1152        ['conv2d_275[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_276 (Batch  (None, 6, 6, 384)   1152        ['conv2d_276[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_279 (Batch  (None, 6, 6, 384)   1152        ['conv2d_279[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 batch_normalization_280 (Batch  (None, 6, 6, 384)   1152        ['conv2d_280[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 conv2d_281 (Conv2D)            (None, 6, 6, 192)    393216      ['average_pooling2d_26[0][0]']   
                                                                                                  
 batch_normalization_273 (Batch  (None, 6, 6, 320)   960         ['conv2d_273[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_275 (Activation)    (None, 6, 6, 384)    0           ['batch_normalization_275[0][0]']
                                                                                                  
 activation_276 (Activation)    (None, 6, 6, 384)    0           ['batch_normalization_276[0][0]']
                                                                                                  
 activation_279 (Activation)    (None, 6, 6, 384)    0           ['batch_normalization_279[0][0]']
                                                                                                  
 activation_280 (Activation)    (None, 6, 6, 384)    0           ['batch_normalization_280[0][0]']
                                                                                                  
 batch_normalization_281 (Batch  (None, 6, 6, 192)   576         ['conv2d_281[0][0]']             
 Normalization)                                                                                   
                                                                                                  
 activation_273 (Activation)    (None, 6, 6, 320)    0           ['batch_normalization_273[0][0]']
                                                                                                  
 mixed9_1 (Concatenate)         (None, 6, 6, 768)    0           ['activation_275[0][0]',         
                                                                  'activation_276[0][0]']         
                                                                                                  
 concatenate_5 (Concatenate)    (None, 6, 6, 768)    0           ['activation_279[0][0]',         
                                                                  'activation_280[0][0]']         
                                                                                                  
 activation_281 (Activation)    (None, 6, 6, 192)    0           ['batch_normalization_281[0][0]']
                                                                                                  
 mixed10 (Concatenate)          (None, 6, 6, 2048)   0           ['activation_273[0][0]',         
                                                                  'mixed9_1[0][0]',               
                                                                  'concatenate_5[0][0]',          
                                                                  'activation_281[0][0]']         
                                                                                                  
 global_average_pooling2d_2 (Gl  (None, 2048)        0           ['mixed10[0][0]']                
 obalAveragePooling2D)                                                                            
                                                                                                  
 dense_4 (Dense)                (None, 256)          524544      ['global_average_pooling2d_2[0][0
                                                                 ]']                              
                                                                                                  
 dropout_2 (Dropout)            (None, 256)          0           ['dense_4[0][0]']                
                                                                                                  
 dense_5 (Dense)                (None, 5)            1285        ['dropout_2[0][0]']              
                                                                                                  
==================================================================================================
Total params: 22,328,613
Trainable params: 525,829
Non-trainable params: 21,802,784
__________________________________________________________________________________________________
Log confusion matrix to TensorBoard
With the following code you can log the confusion matrix for all epochs.

%load_ext tensorboard


class_names = list(labels)
def plot_to_image(figure):    
    buf = io.BytesIO()
    plt.savefig(buf, format='png')
    plt.close(figure)
    buf.seek(0)

    digit = tf.image.decode_png(buf.getvalue(), channels=4)
    digit = tf.expand_dims(digit, 0)

    return digit

def plot_confusion_matrix(cm, class_names): 
    figure = plt.figure(figsize=(8, 8)) 
    plt.imshow(cm, interpolation='nearest', cmap=plt.cm.Accent) 
    plt.title("Confusion matrix") 
    plt.colorbar() 
    tick_marks = np.arange(len(class_names)) 
    plt.xticks(tick_marks, class_names, rotation=45) 
    plt.yticks(tick_marks, class_names)

    cm = np.around(cm.astype('float') / cm.sum(axis=1)[:, np.newaxis], decimals=2)  
    threshold = cm.max() / 2. 

    for i, j in itertools.product(range(cm.shape[0]), range(cm.shape[1])):   
        color = "white" if cm[i, j] > threshold else "black"   
        plt.text(j, i, cm[i, j], horizontalalignment="center", color=color)  
    
    plt.tight_layout() 
    plt.ylabel('True label') 
    plt.xlabel('Predicted label') 

    return figure

# Following function will make predictions from the model and log the confusion matrix as an image. 
def log_confusion_matrix(epoch, logs):
    predictions = np.argmax(model.predict(test_gen), axis=1)
    cm = confusion_matrix(test_gen.classes, predictions)
    figure = plot_confusion_matrix(cm, class_names=class_names)
    cm_image = plot_to_image(figure)
    
    with file_writer_cm.as_default():
        tf.summary.image("Confusion Matrix", cm_image, step=epoch)

# Remove previous log folder
!rm -fr logs
logdir = os.path.join("logs", datetime.datetime.now().strftime("%Y%m%d-%H%M%S"))

# Run tensorBoard
%tensorboard --logdir logs
Fitting Model
#create a writer variable for writing into the log folder.
file_writer_cm = tf.summary.create_file_writer(logdir)

tensorboard = TensorBoard(logdir, histogram_freq=1)


BATCH_SIZE = 64
EPOCHS = 50

Checkpoint = ModelCheckpoint(filepath = 'model-{epoch:02d}-{val_accuracy:.2f}-{val_loss:.2f}.h5',monitor = 'val_loss', verbose = 1, save_best_only = True,mode = 'min')

ES = EarlyStopping(monitor = 'val_loss',min_delta = 0.001,patience = 5,mode = 'min',restore_best_weights = True,verbose = 1)

RL = ReduceLROnPlateau(monitor = 'val_loss',factor = 0.3,patience = 5,verbose = 1,mode = 'min')

callbacks = [ES,RL,tensorboard,Checkpoint,LambdaCallback(on_epoch_end=log_confusion_matrix)]

history = model.fit(train_gen,validation_data = valid_gen,epochs = EPOCHS,callbacks = callbacks)
Epoch 1/50
408/408 [==============================] - ETA: 0s - loss: 0.4565 - accuracy: 0.8482
Epoch 00001: val_loss improved from inf to 0.50044, saving model to model-01-0.82-0.50.h5
408/408 [==============================] - 3092s 8s/step - loss: 0.4565 - accuracy: 0.8482 - val_loss: 0.5004 - val_accuracy: 0.8229 - lr: 1.0000e-04
Epoch 2/50
408/408 [==============================] - ETA: 0s - loss: 0.2555 - accuracy: 0.9155
Epoch 00002: val_loss did not improve from 0.50044
408/408 [==============================] - 266s 652ms/step - loss: 0.2555 - accuracy: 0.9155 - val_loss: 0.5370 - val_accuracy: 0.8087 - lr: 1.0000e-04
Epoch 3/50
408/408 [==============================] - ETA: 0s - loss: 0.2098 - accuracy: 0.9322
Epoch 00003: val_loss did not improve from 0.50044
408/408 [==============================] - 267s 653ms/step - loss: 0.2098 - accuracy: 0.9322 - val_loss: 0.5015 - val_accuracy: 0.8249 - lr: 1.0000e-04
Epoch 4/50
408/408 [==============================] - ETA: 0s - loss: 0.1944 - accuracy: 0.9340
Epoch 00004: val_loss did not improve from 0.50044
408/408 [==============================] - 267s 654ms/step - loss: 0.1944 - accuracy: 0.9340 - val_loss: 0.5127 - val_accuracy: 0.8190 - lr: 1.0000e-04
Epoch 5/50
408/408 [==============================] - ETA: 0s - loss: 0.1732 - accuracy: 0.9410
Epoch 00005: val_loss did not improve from 0.50044
408/408 [==============================] - 260s 638ms/step - loss: 0.1732 - accuracy: 0.9410 - val_loss: 0.5112 - val_accuracy: 0.8269 - lr: 1.0000e-04
Epoch 6/50
408/408 [==============================] - ETA: 0s - loss: 0.1674 - accuracy: 0.9439
Epoch 00006: val_loss improved from 0.50044 to 0.47950, saving model to model-06-0.83-0.48.h5
408/408 [==============================] - 262s 641ms/step - loss: 0.1674 - accuracy: 0.9439 - val_loss: 0.4795 - val_accuracy: 0.8323 - lr: 1.0000e-04
Epoch 7/50
408/408 [==============================] - ETA: 0s - loss: 0.1641 - accuracy: 0.9450
Epoch 00007: val_loss improved from 0.47950 to 0.45921, saving model to model-07-0.85-0.46.h5
408/408 [==============================] - 258s 632ms/step - loss: 0.1641 - accuracy: 0.9450 - val_loss: 0.4592 - val_accuracy: 0.8465 - lr: 1.0000e-04
Epoch 8/50
408/408 [==============================] - ETA: 0s - loss: 0.1447 - accuracy: 0.9506
Epoch 00008: val_loss did not improve from 0.45921
408/408 [==============================] - 258s 633ms/step - loss: 0.1447 - accuracy: 0.9506 - val_loss: 0.4945 - val_accuracy: 0.8372 - lr: 1.0000e-04
Epoch 9/50
408/408 [==============================] - ETA: 0s - loss: 0.1428 - accuracy: 0.9507
Epoch 00009: val_loss did not improve from 0.45921
408/408 [==============================] - 257s 630ms/step - loss: 0.1428 - accuracy: 0.9507 - val_loss: 0.4996 - val_accuracy: 0.8342 - lr: 1.0000e-04
Epoch 10/50
408/408 [==============================] - ETA: 0s - loss: 0.1368 - accuracy: 0.9538
Epoch 00010: val_loss did not improve from 0.45921
408/408 [==============================] - 257s 630ms/step - loss: 0.1368 - accuracy: 0.9538 - val_loss: 0.4726 - val_accuracy: 0.8426 - lr: 1.0000e-04
Epoch 11/50
408/408 [==============================] - ETA: 0s - loss: 0.1286 - accuracy: 0.9558
Epoch 00011: val_loss did not improve from 0.45921
408/408 [==============================] - 254s 623ms/step - loss: 0.1286 - accuracy: 0.9558 - val_loss: 0.4921 - val_accuracy: 0.8387 - lr: 1.0000e-04
Epoch 12/50
408/408 [==============================] - ETA: 0s - loss: 0.1308 - accuracy: 0.9555Restoring model weights from the end of the best epoch: 7.

Epoch 00012: ReduceLROnPlateau reducing learning rate to 2.9999999242136255e-05.

Epoch 00012: val_loss did not improve from 0.45921
408/408 [==============================] - 251s 616ms/step - loss: 0.1308 - accuracy: 0.9555 - val_loss: 0.5051 - val_accuracy: 0.8328 - lr: 1.0000e-04
Epoch 00012: early stopping
Learning curves
#Plot the Loss Curves
plt.figure(figsize=[8,6])
plt.plot(history.history['loss'],'r',linewidth=3.0)
plt.plot(history.history['val_loss'],'b',linewidth=3.0)
plt.legend(['Training loss', 'Validation Loss'],fontsize=18)
plt.xlabel('Epochs ',fontsize=16)
plt.ylabel('Loss',fontsize=16)
plt.title('Loss Curves',fontsize=16)
plt.show()

#Plot the Accuracy Curves
plt.figure(figsize=[8,6])
plt.plot(history.history['accuracy'],'r',linewidth=3.0)
plt.plot(history.history['val_accuracy'],'b',linewidth=3.0)
plt.legend(['Training Accuracy', 'Validation Accuracy'],fontsize=18)
plt.xlabel('Epochs ',fontsize=16)
plt.ylabel('Accuracy',fontsize=16)
plt.title('Accuracy Curves',fontsize=16)   
plt.show()


Evaluation Metrics
from sklearn.metrics import confusion_matrix, classification_report
import seaborn as sns
import matplotlib.pyplot as plt
import numpy as np

predicted_classes = np.argmax(model.predict(test_gen), axis = 1)

confusionmatrix = confusion_matrix(test_gen.classes, predicted_classes)
plt.figure(figsize = (16, 16))
sns.heatmap(confusionmatrix, cmap = 'Blues', annot = True, cbar = True)

print(classification_report(test_gen.classes, predicted_classes))
              precision    recall  f1-score   support

           0       1.00      0.99      0.99        89
           1       0.76      0.80      0.78       322
           2       0.95      0.93      0.94      1034
           3       0.83      0.79      0.81       234
           4       0.96      0.97      0.97      2660

    accuracy                           0.94      4339
   macro avg       0.90      0.90      0.90      4339
weighted avg       0.94      0.94      0.94      4339


Testing Loss & Accuracy
loss,acc = model.evaluate(test_gen)
217/217 [==============================] - 43s 195ms/step - loss: 0.1791 - accuracy: 0.9387
